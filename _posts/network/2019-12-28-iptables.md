---
layout: post
title: iptables
tag: network
---

# iptables简述

iptables对包的处理有可能会经过5个阶段，分别为**PREROUTING**, **INPUT**, **FORWARD**, **OUTPUT**和**POSTROUTING**。这5个阶段对应了iptables的5中类型的链，在iptables指令中用**-A**指定链名称。

当一个包到了某个主机，如果ip地址和主机的相同。那么该包的iptables处理路线是

PREOUNTING -> INPUT -> ..

如果处理完，向应一个包，当包要发出去时，该包的处理路线是

.. -> OUTPUT -> POSTROUTING

.. -> PREROUTING -> FORWARD -> POSTROUTING -> ..


iptables中有5种类型的表，分别为**raw**, **mangle**,**nat**, **filter**和**security**。其中常用的有 mangle, nat和filter三个表。

**mangle**表可处理所有类型的链：
- PREROUTING 链
- INPUT 链
- FORWARD 链
- OUTPUT 链
- POSTROUTING 链

**nat**可以处理的链有：
- PREROUTING 链
- OUTPUT 链
- POSTROUTING 链

**filter**可以处理的链有：
- INPUT 链
- FORWARD 链
- OUTPUT 链

如果包经过了iptables的某个阶段，这个阶段中如果表可以对其处理，那么这三个表的**优先级**为：

mangle -> nat -> filter


# iptables命令用法(chain操作)

## 查看链

```shell
# 查看所有链(filter表)
iptables -L

# 查看INPUT链(filter表)
iptables -L INPUT

# 查看nat表的所有链
iptables -t nat -L
```

## 设置链的默认目标(Policy)

链的默认目标(Policy)是指在没有匹配链中的所有规则时，会采用的目标。

```shell
# 设置filter表INPUT链的默认目标为DROP
iptables -P INPUT DROP

# 设置filter表的OUTPUT链的默认目标为ACCEPT
iptables -P OUPUT ACCEPT
```

## 往后追加规则

```shell
# iptables往后追加的基础语法
iptables -t <table> -A <chain> -p <protocol> -s <src_ip> -d <dst_ip>  -dport <dst_port> -sport <src_port>  -j <target>

# 允许tcp的80端口进入
iptables -A INPUT -p tcp -dport 80 -j ACCEPT

# 禁止所有包进入
iptables -A -j DROP
```
